# Dockerfile para demucs basicamente.
#ESENCIAL. Hai masivos problemas de compatibilidad entre as ferramentas usadas. Incompatibilidades con docker, cuda, demucs, whisperx...
#Tuven que aislar dependencias e facer un monton de combinacions hasta encontrar unha que funcionara. Quizais se poda simplificar.

# Dockerfile para demucs. Actualizado con fijacion de dependencias
FROM pytorch/pytorch:2.3.0-cuda11.8-cudnn8-devel

ENV DEBIAN_FRONTEND=noninteractive
#arreglar as variables de entorno intel mkl, polo tema de haber arreglado o de av.
ENV MKL_SERVICE_FORCE_INTEL=1
ENV MKL_THREADING_LAYER=INTEL
ENV OMP_NUM_THREADS=1

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    imagemagick \
    libpangocairo-1.0-0 \
    libpangoft2-1.0-0 \
    libmagickwand-dev \
    wget \
    curl \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

#Instalar FFmpeg mais moderno con soporte AV1
RUN add-apt-repository ppa:savoury1/ffmpeg4 -y || true && \
    apt-get update && \
    apt-get install -y --no-install-recommends ffmpeg && \
    rm -rf /var/lib/apt/lists/*

#Esto parchea policy.xml de imagemagick. Necesario porque daba error. 
#https://legacy.imagemagick.org/discourse-server/viewtopic.php?t=26801
RUN sed -i 's|<policy domain="path" rights="none" pattern="@\*"/>|<!-- <policy domain="path" rights="none" pattern="@*"/> -->|' /etc/ImageMagick-6/policy.xml || true

WORKDIR /KaraokeProject

RUN pip install --no-cache-dir --upgrade \
    pip==24.0 \
    setuptools==69.5.1 \
    wheel==0.43.0

COPY requirementsA.txt /KaraokeProject/
RUN pip install --no-cache-dir -r requirementsA.txt

COPY . /KaraokeProject

RUN mkdir -p /data /KaraokeProject/input /KaraokeProject/output /KaraokeProject/separated

EXPOSE 5000
CMD ["python", "app.py"]